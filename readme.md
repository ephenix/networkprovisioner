# Network Provisioner

## Description

This template was developed to accomplish the following:

1. Provision VPCs in AWS Control Tower sub-accounts from a common address pool
2. Automatically provision Transit Gateway Attachments to these VPCs
3. Automatically Accept these attachments (even if the Transit gateway is not configured to automatically accept)

> Note: This is an MVP solution for a specific use case, but it's meant to be customized. For example, the template for VPCs currently only provisions two private subnets in each VPC, but it can be modified to include public/private subnets with IGWs, NAT gateways, and custom routing tables.

> This solution is offered with no warranties, express or implied. You are responsible for examining, testing, customizing, and understanding the code and templates and all changes and costs they incur.

## Requirements

1. A multi-account organization with pre-existing cross-account roles -- This template has been designed for AWS Control Tower, but this can work with custom stack-set execution roles as well.
2. A transit gateway which is shared with all necessary sub-accounts using Resource Access Manager
3. An S3 bucket to store the templates used by and generated by this project

## Overview

### Services Overview
![Services Overview](./img/ServiceDiagram.png)

This is a serverless solution for provisioning CIDRs from a common address pool. When you install the solution, you'll select a master address pool (ie. 10.0.0.0/16) and then sizes for both VPC and Subnet CIDRs (ie. /22, /24, /26, etc)

Once provisioned, you will be able to provision VPCs in sub-accounts using Service Catalog. You can also share this service catalog portfolio with another account to assign to a networking or operations team.

### Master Template
![Installation](./img/InstallationDiagram.png)

The master Template (templates/NetworkProvisionerCore.yaml) provisions the majority of the configurations an resources for this project.

It customizes the two templates used by the Service Catalog products it provisions by downloading the master templates, token-replacing them, and re-uploading them to the templates bucket under a /transformed/ key path.

Token replacement probably isn't the best way to accomplish this goal -- a better way might be to parameterize the values and use Constraints through Service Catalog to limit / auto-fill these variables.

### Add Account Product

![Add Account](./img/AddAccountProduct.png)

The Add Account product is the next step after installation. Right now, it's designed as a semi-manual process to add sub-accounts as targets under the portfolio.

In the future, another lambda custom resource could be added to the master template which would automatically add organization sub-accounts to the portfolio by listing them through the Organizations API and building a product for each account. The limitation here is that I'm not aware of a way to deploy a variable number of independent stacks or nested stacks, so the products deployed through that lambda custom resource would need to be managed manually.

> Note: Deploying the New Target Account product is also where we select the role names for the cross-account permissions. These are auto-filled with AWS Control Tower cross-account management roles.

### New VPC Product

![New VPC](./img/NewVPCDiagram.png)

For each account we add, we get a Product added to the portfolio which provisions VPCs in that account.

Each account gets its own product due to the way Stack Set Constraints are added (Only 1 per Product - essentially, a given product is limited to a single sub-account)

> Note: This template also sets up cross-account CloudWatch Events to trigger a lambda function to accept the transit gateway attachment. This is unneccessary if your transit gateway is already configured with auto-acceptance. Unfortunately, transit gateways cannot be re-configured once deployed to auto-accept. I built the solution this way to achieve the same functionality without an invasive network change, but in the future, Transit Gateways may be re-configurable to where this is no longer necessary.

## Installation Instructions

1. Clone this repo
2. run build.py, note the output folder.
3. sync or upload the contents of the output folder to an S3 bucket
> Note: The CloudFormation execution role used in the Master Account needs access to read and write templates to this bucket.
4. Deploy the NetworkProvisionerCore.yaml Cloudformation template in the Organizations Master Account
5. Enter the CIDR for the total network you wish to provision from in AWS, Enter the name of the S3 Bucket where the templates and lambda zips have been synced to, and enter the transit gateway ID to connect VPCs to.

> Remember: This transit gateway must be pre-shared with sub accounts -- this template does not manage this configuration.

## Post Deployment Workflow

1. In Service Catalog, and we will launch an instance of the "New Network Target Account" product.
2. Enter a name for the product deployment, then enter template parameters: Account Id, Account Name, and the Admin Role as well as Execution role are pre-filled with AWS Control Tower roles.
3. Launch the product.

4. After completion, we should have a new Product for the target account. Deploying an instance of this product will deploy the next VPC